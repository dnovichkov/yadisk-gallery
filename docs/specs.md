# REST API Яндекс.Диска: полное техническое руководство для Android

**Техническая реализуемость фотогалереи на базе Яндекс.Диска — подтверждена.** API предоставляет все необходимые возможности: получение списка файлов с пагинацией, фильтрацию по типу медиа, генерацию превью изображений и скачивание файлов. Ключевое преимущество — работа с публичными папками **полностью без авторизации**, что позволяет создать приложение для просмотра shared-галерей без OAuth-интеграции.

---

## Официальная документация и базовые эндпоинты

Документация REST API доступна на **yandex.ru/dev/disk/rest/** (русская версия) и **yandex.com/dev/disk/api/concepts/about.html** (английская). Все запросы выполняются к базовому URL `https://cloud-api.yandex.net/v1/disk/`, формат ответов — JSON в кодировке UTF-8.

Для авторизованных запросов требуется заголовок:
```http
Authorization: OAuth <access_token>
```

### Ключевые эндпоинты для фотогалереи

| Операция | Endpoint | Авторизация |
|----------|----------|-------------|
| Метаинформация о папке | `GET /v1/disk/resources?path=<путь>` | OAuth |
| Плоский список файлов | `GET /v1/disk/resources/files` | OAuth |
| Публичные ресурсы | `GET /v1/disk/public/resources?public_key=<ключ>` | **Не требуется** |
| Скачивание файла | `GET /v1/disk/resources/download?path=<путь>` | OAuth |
| Скачивание публичного | `GET /v1/disk/public/resources/download?public_key=<ключ>` | **Не требуется** |

---

## Получение списка файлов и пагинация

API использует классическую модель **limit/offset** для постраничной загрузки. По умолчанию возвращается **20 элементов**, максимум рекомендуется ограничивать **500** записями для избежания таймаутов.

```kotlin
// Пример запроса с пагинацией и фильтром по изображениям
GET /v1/disk/resources/files?media_type=image&limit=50&offset=0&preview_size=M&sort=-created
```

### Параметры для галереи изображений

| Параметр | Описание | Пример |
|----------|----------|--------|
| `media_type` | Фильтр по типу: `image`, `video`, `image,video` | `media_type=image` |
| `limit` | Количество элементов (по умолчанию 20) | `limit=50` |
| `offset` | Смещение для пагинации | `offset=100` |
| `sort` | Сортировка: `name`, `created`, `modified`, `size` | `sort=-created` |
| `preview_size` | Размер превью | `preview_size=M` |

Для обратной сортировки добавляется префикс `-` (например, `sort=-modified` — от новых к старым). При запросе содержимого папки **сначала всегда идут подпапки**, затем файлы.

---

## Превью изображений через API

API автоматически генерирует превью для изображений. URL превью возвращается в поле `preview` каждого файла и имеет формат `https://downloader.disk.yandex.ru/preview/...`

### Доступные размеры превью

**T-shirt размеры (квадратные):** `XXXS` (50px), `XXS` (75px), `XS` (100px)

**T-shirt размеры (пропорциональные по ширине):** `S` (150px), `M` (300px), `L` (500px), `XL` (800px), `XXL` (1024px), `XXXL` (1280px)

**Точные размеры:** `128` (ширина 128px), `128x256` (точный размер с обрезкой), `x256` (высота 256px)

Параметр `preview_crop=true` обрезает изображение по центру до заданного размера — идеально для grid-галереи с квадратными плитками.

---

## Скачивание файлов

Скачивание реализовано в **два этапа**: сначала запрос к API возвращает временную ссылку, затем файл скачивается по этой ссылке **без авторизации**.

```kotlin
// Шаг 1: Получить временную ссылку
val response = api.getDownloadLink("/photos/vacation.jpg")
// Ответ: {"href": "https://downloader.dst.yandex.ru/disk/...", "method": "GET"}

// Шаг 2: Скачать по полученной ссылке (Authorization не нужен)
val file = httpClient.get(response.href)
```

Временная ссылка имеет **ограниченный срок действия**, поэтому её следует использовать сразу после получения.

---

## OAuth 2.0 авторизация для Android

### Регистрация приложения

Приложение регистрируется в консоли **oauth.yandex.ru/client/new/**. Для Android указываются: package name из `build.gradle`, SHA256-отпечаток сертификата подписи и ссылка на Google Play (опционально).

После регистрации выдаются **Client ID** и **Client Secret**. Для Android рекомендуется **Authorization Code с PKCE** — Client Secret можно не использовать в мобильном приложении.

### Scopes для работы с Диском

| Scope | Описание |
|-------|----------|
| `cloud_api:disk.read` | Чтение всего Диска (минимум для галереи) |
| `cloud_api:disk.write` | Запись (не нужен для просмотра) |
| `cloud_api:disk.info` | Информация о квотах Диска |

### Yandex Login SDK для Android

Официальный SDK упрощает интеграцию OAuth. Подключение через Gradle:

```gradle
dependencies {
    implementation 'com.yandex.android:authsdk:3.1.4'
}
android {
    defaultConfig {
        manifestPlaceholders = [YANDEX_CLIENT_ID: "YOUR_CLIENT_ID"]
    }
}
```

```kotlin
// Использование SDK
val sdk = YandexAuthSdk.create(YandexAuthOptions(context))
val launcher = registerForActivityResult(YandexAuthSdk.createLoginContract()) { result ->
    result.onSuccess { token ->
        val accessToken = token.value // Использовать для API запросов
    }
}
launcher.launch(YandexAuthLoginOptions())
```

SDK автоматически использует **SSO** через установленные приложения Яндекса, иначе открывает Custom Tabs.

### Время жизни токенов

Access token живёт **до 1 года** и автоматически продлевается при использовании. Refresh token также поддерживается — рекомендуется обновлять долгоживущие токены каждые **3 месяца**.

---

## Публичные папки без авторизации

**Ключевая возможность:** API позволяет работать с публичными ресурсами **полностью без OAuth**. Вместо токена используется `public_key` — сама публичная ссылка или закодированный ключ.

```kotlin
// Получить содержимое публичной папки БЕЗ авторизации
GET /v1/disk/public/resources?public_key=https://yadi.sk/d/AbCdEfGhIjK&limit=50&preview_size=M

// Скачать файл из публичной папки
GET /v1/disk/public/resources/download?public_key=https://yadi.sk/d/AbCdEfGhIjK&path=/photo.jpg
```

### Доступные операции без авторизации

✅ Метаданные файлов (имя, размер, дата, MIME-тип, MD5)
✅ Список содержимого папки с пагинацией
✅ Превью изображений всех размеров
✅ Скачивание файлов

❌ Публикация/закрытие доступа
❌ Загрузка файлов
❌ Сохранение в свои "Загрузки"

Это позволяет создать приложение-галерею для просмотра **shared-альбомов** без необходимости авторизации пользователя.

---

## Ограничения и лимиты API

### Rate limits

**Официальные числовые лимиты не опубликованы** в документации. Известно:
- HTTP **429 Too Many Requests** возвращается при превышении
- Скорость загрузки может ограничиваться до **128 КиБ/с** для определённых типов файлов
- Рекомендуется реализовать **exponential backoff** и retry-логику

### Лимиты на файлы

| Тариф | Макс. размер файла | Объём хранилища |
|-------|-------------------|-----------------|
| Бесплатный | **1 ГБ** | 5-10 ГБ |
| Яндекс 360 Премиум | **50 ГБ** | до 3 ТБ |
| Яндекс 360 Бизнес | **100 ГБ** | расширенный |

При превышении размера возвращается **413 Payload Too Large**.

### Ограничения на ответ API

Параметр `limit` по умолчанию 20, рекомендуемый максимум — **500** элементов. Для больших папок используйте пагинацию через `offset`.

---

## SDK и библиотеки для Android

### Официальный Java SDK

**Репозиторий:** github.com/yandex-disk/yandex-disk-restapi-java
**Maven:** `com.yandex.android:disk-restapi-sdk:1.03`
**Статус:** ⚠️ Слабо поддерживается (последние обновления 2015-2016), но функционален

```gradle
implementation 'com.yandex.android:disk-restapi-sdk:1.03'
```

### Рекомендация для новых проектов

Использовать **REST API напрямую через Retrofit + OkHttp** — это даёт больше контроля и актуальность:

```kotlin
interface YandexDiskApi {
    @GET("v1/disk/resources/files")
    suspend fun getImages(
        @Header("Authorization") token: String,
        @Query("media_type") mediaType: String = "image",
        @Query("limit") limit: Int = 50,
        @Query("offset") offset: Int = 0,
        @Query("preview_size") previewSize: String = "M"
    ): FilesResponse
    
    @GET("v1/disk/public/resources")
    suspend fun getPublicFolder(
        @Query("public_key") publicKey: String,
        @Query("limit") limit: Int = 50,
        @Query("preview_size") previewSize: String = "M"
    ): ResourceResponse
}
```

---

## Техническая реализуемость функций из ТЗ

| Требование | Статус | Реализация |
|------------|--------|------------|
| Список файлов/папок | ✅ Полная поддержка | `GET /resources?path=` или `/resources/files` |
| Пагинация | ✅ limit/offset | Параметры `limit` и `offset` |
| Фильтр по фото/видео | ✅ Поддерживается | `media_type=image,video` |
| Превью изображений | ✅ Множество размеров | `preview_size=S/M/L/XL` |
| Скачивание файлов | ✅ Двухэтапный процесс | `/download` → временная ссылка |
| OAuth для Android | ✅ SDK + PKCE | `authsdk:3.1.4` |
| Публичные папки без auth | ✅ Полная поддержка | `public_key` вместо OAuth |
| Android SDK | ⚠️ Устаревший | Рекомендуется Retrofit |

### Потенциальные сложности

1. **Неопубликованные rate limits** — необходимо реализовать защитную retry-логику
2. **Throttling скачивания** (128 КиБ/с) — может влиять на UX при загрузке оригиналов
3. **Устаревший SDK** — лучше использовать прямые REST-вызовы
4. **Лимит 1 ГБ на файл** для бесплатных пользователей — актуально для видео

---

## Заключение

API Яндекс.Диска **полностью подходит** для создания Android-приложения фотогалереи. Особенно ценна возможность работы с публичными папками без авторизации — это упрощает архитектуру для shared-галерей. Рекомендуется использовать Retrofit вместо устаревшего SDK и реализовать exponential backoff для обработки недокументированных rate limits. Все ключевые функции ТЗ технически реализуемы через REST API.